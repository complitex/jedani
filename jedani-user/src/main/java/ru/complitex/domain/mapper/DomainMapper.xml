<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ru.complitex.domain.mapper.DomainMapper">
    <resultMap id="domainResultMap" type="ru.complitex.domain.entity.Domain">
        <id column="id" property="id"/>
        <result column="object_id" property="objectId"/>
        <result column="parent_id" property="parentId"/>
        <result column="parent_entity_id" property="parentEntityId"/>
        <result column="start_date" property="startDate"/>
        <result column="end_date" property="endDate"/>
        <result column="status" property="status"/>
        <result column="permission_id" property="permissionId"/>
        <result column="external_id" property="externalId"/>
        <result column="entity_name" property="entityName"/>
        <collection column="entityName=entity_name, objectId=id" property="attributes"
                    select="ru.complitex.domain.mapper.AttributeMapper.selectAttributes"/>
    </resultMap>

    <!--suppress SqlResolve -->
    <insert id="insertDomain" parameterType="ru.complitex.domain.entity.Domain">
        insert into ${entityName} (object_id, parent_id, parent_entity_id, start_date, end_date, `status`,
          permission_id, external_id)
        value (#{objectId}, #{parentId}, #{parentEntityId}, #{startDate}, #{endDate}, #{status},
          #{permissionId}, #{externalId})
    </insert>

    <!--suppress SqlResolve -->
    <select id="hasDomain" parameterType="ru.complitex.domain.entity.Domain" resultType="boolean">
        select count(id) > 0 from ${entityName} where external_id = #{externalId}
    </select>

    <!--suppress SqlResolve -->
    <select id="selectDomain" parameterType="ru.complitex.domain.entity.Domain" resultMap="domainResultMap">
        select '${entityName}' entity_name, d.* from ${entityName} d
        <where>
            <if test="objectId != null">and d.object_id = #{objectId} and `status` = 1</if>
            <if test="externalId != null">and d.external_id = #{externalId}</if>
        </where>
    </select>

    <select id="selectDomains" parameterType="ru.complitex.common.entity.FilterWrapper" resultMap="domainResultMap">
        select '${object.entityName}' entity_name, d.* from ${object.entityName} d
    </select>

    <!--todo dev join filter -->
    <select id="selectDomainsCount" parameterType="ru.complitex.common.entity.FilterWrapper" resultType="long">
        select count(object_id) from ${object.entityName}
    </select>


</mapper>