<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ru.complitex.jedani.worker.mapper.WorkerMapper">
    <resultMap id="workerResultMap" type="ru.complitex.jedani.worker.entity.Worker"
               extends="ru.complitex.domain.mapper.DomainMapper.domainResultMap">
        <result column="left" property="left"/>
        <result column="right" property="right"/>
        <result column="level" property="level"/>
        <result column="sub_worker_count" property="subWorkerCount"/>
    </resultMap>

    <select id="selectMaxJId" resultType="string">
        select max(lpad(`text`, 6, '0')) from worker_attribute where entity_attribute_id = 1
    </select>

    <select id="selectIsExistJId" resultType="boolean">
        select count(*) > 0 from worker_attribute where entity_attribute_id = 1 and `text` = #{jid}
    </select>

    <select id="selectSubWorkersCount" parameterType="long" resultType="int">
        select count(wa.id)from  worker_attribute wa
          where wa.entity_attribute_id = 19 and wa.status = 1 and (wa.text = #{objectId} or
            wa.text like concat('%/', #{objectId}, '/%') or  wa.text like concat('%/', #{objectId}));
    </select>

    <sql id="selectWorkersWhereNode">
        <if test="object.left != null and object.right != null">
            and d.left > #{object.left} and #{object.right} > d.right

            <if test="filter == 'level3' and object.level != null">
                and #{object.level} + 3 > d.level
            </if>
        </if>
    </sql>

    <sql id="selectWorkersOrderNode">

    </sql>

    <!--suppress SqlResolve -->
    <select id="selectWorkers" parameterType="ru.complitex.common.entity.FilterWrapper" resultMap="workerResultMap">
        select distinct d.*, '${object.entityName}' entity_name,
          (select count(w.object_id) from worker w where w.left > d.left and d.right > w.right and w.status = 1) sub_worker_count
        <include refid="ru.complitex.domain.mapper.DomainMapper.selectDomainsFromSort"/>
        <include refid="ru.complitex.domain.mapper.DomainMapper.selectDomainsFromWhere"/>
        <include refid="selectWorkersWhereNode"/>
        <include refid="ru.complitex.domain.mapper.DomainMapper.selectDomainsOrderSort"/>
        <include refid="selectWorkersOrderNode"/>
        ${limit}
    </select>

    <!--suppress SqlResolve -->
    <select id="selectWorkersCount" parameterType="ru.complitex.common.entity.FilterWrapper" resultType="long">
        select count(distinct d.object_id)
        <include refid="ru.complitex.domain.mapper.DomainMapper.selectDomainsFromWhere"/>
        <include refid="selectWorkersWhereNode"/>
    </select>

    <select id="selectWorker" parameterType="long" resultMap="workerResultMap">
        <include refid="ru.complitex.domain.mapper.DomainMapper.selectDomainSql"/>
    </select>

</mapper>